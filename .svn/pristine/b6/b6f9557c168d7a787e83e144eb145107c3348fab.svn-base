<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">

	<section class="content-header">
	  <h1>
		<?php echo $titleHeader; ?>
		<small>
		<?php echo $descHeader ?>
		</small>
	  </h1>
	  <ol class="breadcrumb">
		<li><a href="<?php echo base_url(); ?>"><i class="fa fa-dashboard"></i> Inicio</a></li>
		<li><a href="<?php echo base_url($currentClass); ?>"><?php echo $currentClass ?></a></li>
		<li class="active"><?php echo $currentAction ?></li>
	  </ol>
	</section>	  

	<section class="content">
 	<div class="box" id="bx_cliente">
		<form role="form" data-toggle="validator" id="frm_pedido">
		<div class="box-header with-border">
			<h3 class="box-title"><?php echo $descHeader; ?><label id="lbl_id_pedido"></label></h3>
					<div class="box-tools pull-right">
						<a href="<?php echo base_url(); ?>Comprobante/verComprobante/<?php echo $pedEdit['id'];?> " target="blank" class="btn btn-default"><i class="fa fa-print"></i> Comprobante
						</a>
					</div>
				</div>
		<div class="box-body">

		<div class="row">
			<div class="col-lg-3 col-md-12 col-xs-12">
					<div class="form-group" id="div_cliente">
								    <label for="cntrl_id_cliente" class="control-label">
								    <?php echo $p_formselectcliente; ?>:</label>
								    <select id="cntrl_id_cliente"  
								    class="form-control" 
								    name="cntrl_id_cliente" 
								    style="width:100%;" data-error="Seleccione un cliente!" required>
								    
								    </select>
   			        </div><!-- div_cliente -->
   					<div class="form-group" id="div_clientexiste">
   							     <label for="cntrl_id_cliente" class="control-label">Cliente:</label>
								 <br/>   
								 <label id="lbl_Nombcliente"></label>
					</div><!-- div_clientexiste -->
			</div><!-- col1 -->
				
				                    
				                    
			<div class="col-lg-3 col-md-12  col-xs-12">
               		<div class="form-group">
    	                  	    <label><?php echo $p_fechaingresopedido; ?>: (<?php echo $pedEdit['diastranscurridos']; ;?>) d&iacute;as.</label>
		                    	<div class="input-group">
	                      			<div class="input-group-addon">
	                        			<i class="fa fa-clock-o"></i>
	                      			</div>
	                      			<input type="text" class="form-control pull-right"	id="fecha_ingreso"/>
	                    		</div><!-- /.input group -->
	                </div><!-- /.form group -->
             </div><!--  col2 -->
			<div class="col-lg-3 col-md-12  col-xs-12">
			   <div class="form-group">
					 <label>Estado: </label>
					 <select style="width:100%;"  id="sl_estado"  class="form-control">
									<?php
									//var_dump($pedEdit);
										  foreach($vEstados  as $est) {
											$sltd = "";
											if ($pedEdit['est_esecuencia'] == $est['secuencia'])
												$sltd = " selected "					  		
										  ?>
										  <option value="<?php echo $est['secuencia'];?>" <?php echo $sltd; ?>><?php echo $est['descripcion']; ?></option>
									<?php } ?>  	
								  </select>
			   </div><!--form-group  -->
			 </div><!-- Col3 -->
			 
			 <div class="col-lg-3 col-md-12  col-xs-12">
			   <div class="form-group">
			 
			 
				                    <label id="lbl_comision">Comisi&oacute;n</label>
				                    <a href="#" id="btn_agregar_comision"title="[+]" >[+]</a>
				                    <br/>
									<!--  <input type="checkbox" id="chk_comision">-->
									<table id="table_comision"></table>	                    
			
			  </div><!--form-group  -->
			 </div><!-- Col4 -->
			 	                    
		</div><!-- Row1 --> 
		
		
		
		
		<div class="row"><!--  Fila 2-->
					<div class="col-lg-6 col-md-6 col-xs-6 text-left">
						<a href="#" class="btn btn-default" id="btnback"><i class="fa  fa-backward"></i> Volver</a>
					</div>
					
					<div class="col-lg-6 col-md-6 col-xs-6 text-right">
						<button  id="btn_guardar_cab" type="submit" class="btn btn-default" title="Guardar pedido" ><i class="fa fa-save"></i> Guardar</button>
					</div><!-- Col 2 -->
		</div> <!-- Row 2 -->
		</div><!-- /.box-body -->
	</form>	
	</div><!-- BOX 1 bx_cliente  -->
	
	<form role="form" data-toggle="validator" id="frm_det_pedido">
	<div class="box" id="bx_agregardetalle"><!-- BOX 2 -->
		<div class="box-header with-border" >
	 			<h3 class="box-title">Detalle Pedido</h3>
	 			<div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
				</div>
		</div>
		<div class="box-body">
			<div class="row">
				<div class="col-lg-2 col-md-2  col-xs-12">
					<div class="form-group">
						<input type="text" class="form-control" id="txt_cantidad" placeholder="Cantidad" required>
					</div>
				</div>
				<div class="col-lg-4 col-md-4  col-xs-12">
					<div class="form-group">												
					<select id="cntrl_id_producto"  class="form-control" name="cntrl_id_producto" data-error="Seleccione un Producto" required></select>
					</div>
				</div>
				<div class="col-lg-3 col-md-3  col-xs-12"><!--  col 3 -->
					<div class="form-group">												
						<input type="text" class="form-control" id="txt_costoventa" placeholder="Costo venta" required>
					</div>
					</div>
				<div class="col-lg-3 col-md-3  col-xs-12"><!--  col 3 -->
					<div class="form-group">																				
						<input type="text" class="form-control" id="txt_precioventa"  placeholder="Precio venta" required>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-10  col-md-10 col-xs-4"><!--  col 1 -->
					<a href="<?php echo base_url(); ?>Productos/agregar" target="blank">Agregar Producto</a>
				</div>
				<div class="col-lg-2  col-md-2 col-xs-8 text-right" ><!--  col 2 -->
					<button  id="btn_guardar_det" type="submit" class="btn btn-default" title="Guardar" ><i class="fa fa-save"></i> Guardar Detalle</button>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12  col-md-12 col-xs-12"><!--  col 1 -->
				<div class="pad box-pane-right" style="min-height: 100px">
					<table id="tabla_detalle">
					</table> 
				</div>
				</div>
			</div>	
			<div class="row">
				<div class="col-lg-8 col-md-7 col-xs-12">
					&nbsp;
				</div>
				<div class="col-lg-4 col-md-5 col-xs-12">
						<div class="table-responsive">
						<table class="table no-margin">
				                  <tbody><tr>
				                    <th style="width:50%">Subtotal:</th>
				                    <td><label id="lbl_subtotal"></label></td>
				                  </tr>
				                  <tr>
				                    <th>
									<input type="checkbox" id="chk_iva">I.V.A</th>
				                    <td><label id="lbl_iva"></label></td>
				                  </tr>
				                  <tr>
				                    <th>TOTAL A PAGAR:</th>
				                    <td><label id="lbl_totalapagar"></label></td>
				                  </tr>
								  
								  <tr>
				                    <th>Abonado:</th>
				                    <td><label id="lbl_totalabonocliente"></label></td>
				                  </tr>
								  
								  
								  <tr>
				                    <th>SALDO A PAGAR:</th>
				                    <td><label id="lbl_totalsaldocliente"></label></td>
				                  </tr>
								  
								 
				        </tbody>
				        </table>
				        </div><!-- Div class table -->     
				</div>
	</div><!-- row -->
		</div> <!-- Box Body -->
	</div><!-- bx_detalle -->
	</form><!-- frm_detalle -->
	
	
	<div class="box" id="bx_caja">
	<div class="row">
				<div class="col-lg-12 col-md-12 col-xs-12">
						
					
						<div class="box box-danger">
							<div class="box-header">
								<h3 class="box-title">Movimiento Cuentas</h3>
								<a href="<?php echo base_url(); ?>Cuenta/verdetallemovimientos/<?php echo $pedEdit['id'];?>">Ver Movimientos</a>
								<div class="box-tools pull-right"><button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
								 <a href="#" id="btn_agregar_caja"title="[+]" >[+]</a>
								</div>
							</div>
							<div class="box-body">
								
						
						
						
								<div class="row">
									
									 
									<div class="col-lg-12 col-md-12  col-xs-12">
										<div class="pad box-pane-right" style="min-height: 100px">
										
										<table class="table" id="tb_resumen_cta"></table>
										</div>
									</div>	
								</div>
								<div class="row">
									<div class="col-lg-6 col-md-12  col-xs-12">
									<div class="table-responsive">
										<table class="table">
										<tbody>
												  <tr>
													<th style="width:50%">Costo Total:</th>
													<td><label id="lbl_totalCosto"></label></td>
												  </tr>
												   <tr>
													<th style="width:50%">Ganancia Total:</th>
													<td><label id="lbl_totalganancia"></label></td>
												  </tr>
										</tbody>
										</table>
									</div><!-- Div class table -->
									</div><!-- Col  -->													
									<div class="col-lg-6 col-md-12  col-xs-12">
									<div class="table-responsive">
										<table class="table" id="tbl_vendedores">
										</table>
									</div><!-- Div class table -->
									</div><!-- Col  -->
								</div><!-- row -->
							</div><!-- box-body -->
						</div><!--  box danger -->
					
						
				</div><!-- COlumna  -->
	</div><!-- row -->
	</div><!-- bx_caja -->

<div class="box box-warning direct-chat direct-chat-warning" id="bx_seguimiento">
<div class="box-header with-border">
	<h3 class="box-title">Seguimiento</h3>
    <div class="box-tools pull-right">
         <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
    </div><!-- tools -->
</div><!-- /.box-header -->
<div class="box-body" id="bx_bd_seguimiento">
<div class="direct-chat-messages">
	<?php foreach($comm  as $c) {
	if ($c['id_user']==1){
	?>
	<!-- Conversations are loaded here -->
	<!-- A la izquierda -->
	<div class="direct-chat-msg">
			<div class="direct-chat-info clearfix">	
				<span class="direct-chat-name pull-left"><?php echo $c['nombre'];?></span>									
			 	<span class="direct-chat-timestamp pull-right"><?php echo $c['fecha_creacion'];?></span>
			</div><!-- /.direct-chat-info -->
			<img class="direct-chat-img" src="<?php echo base_url(); ?>Template/dist/img/user1-128x128.jpg" 
				alt="message user image"><!-- /.direct-chat-img -->
			 <div class="direct-chat-text"><?php echo $c['comentario'];?></div><!-- /.direct-chat-text -->
	</div><!-- /.direct-chat-msg -->
	<?php  
		}else{
	?>		
	<!-- A la derecha -->
     <div class="direct-chat-msg right">
			  <div class="direct-chat-info clearfix">
				<span class="direct-chat-name pull-right"><?php echo $c['nombre'];?></span>
				<span class="direct-chat-timestamp pull-left"><?php echo $c['fecha_creacion'];?></span>
			  </div><!-- /.direct-chat-info -->
			  <img class="direct-chat-img" src="<?php echo base_url(); ?>Template/dist/img/user3-128x128.jpg" alt="message user image"><!-- /.direct-chat-img -->
			  <div class="direct-chat-text">
				<?php echo $c['comentario'];?>
			  </div><!-- /.direct-chat-text -->
			</div><!-- /.direct-chat-msg -->
	 </div><!--/.direct-chat-messages-->
	<?php	}//fin else	?>	
	<?php } //fin loop foreach ?>	               
</div><!-- /.box-body -->
<div class="box-footer">
  <form role="form" data-toggle="validator" id="frm_shout">
  <div class="input-group">
     <input type="text" id="txt_comentario" placeholder="Escribe un mensaje ..." class="form-control">
     <span class="input-group-btn">
         <button  type="submit" class="btn btn-warning btn-flat">Enviar</button>
     </span>
  </div> <!-- Input group -->
  </form>
</div><!-- /.box-footer-->
</div>


</section><!-- /.content -->
</div><!-- /.content-wrapper -->

<!--  Fila comision -->
<div class="modal fade" tabindex="-1" role="dialog" id="div_comision">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
     <form role="form" data-toggle="validator" id="frm_comision">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Agregar Comisi&oacute;n</h4>
      </div>
      <div class="modal-body">
	       
			
					
					<div class="form-group">
						<label>Cuenta Comisi&oacute;n</label>
						<select class="form-control" id="cntrl_id_cta_comision" style="width:40%;"></select>	
					</div><!-- form group -->
					<div class="form-group">
						<label>Porcentaje</label>
						<input type="text"  class="form-control"  style="width:60%;" id="txt_porcentaje">
					</div>

			
			
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        <button class="btn btn-primary" type="submit">Grabar</button>
      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<!-- Modal caja -->
<div class="modal fade" tabindex="1" role="dialog" id="div_agregarcaja">
<form role="form" data-toggle="validator" id="frm_caja">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
     <form role="form" data-toggle="validator" id="frm_caja">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Agregar Movimiento</h4>
      </div>
      <div class="modal-body">
	       
			
				
				<div class="table">
				<div class="row">
							<div class="col-lg-2 col-md-4 col-xs-12">
								<div class="form-group">
									<label>Glosa</label>
									<input type="text" class="form-control" id="txt_glosa" placeholder="Glosa" required>	
								</div>		
							</div>
							<div class="col-lg-2 col-md-4 col-xs-12">
								<div class="form-group">
									<label>Monto</label>
									<input type="text" class="form-control" id="txt_monto" placeholder="monto" required>	
								</div>		
							</div>
							<div class="col-lg-4 col-md-4  col-xs-12">
									<div class="form-group">
									<label>Cta origen.</label>
									<select class="form-control" id="cntrl_id_cta" style="width:80%;">
										
									</select>	
									</div>
							</div>
							<div class="col-lg-4 col-md-4  col-xs-12">
									<div class="form-group">
									<label>Cta Destino.</label>
									<select class="form-control" id="cntrl_id_cta_destino" style="width:80%;">
										
									</select>	
									</div>
							</div>
						</div>
						
				</div>		
				

			
			
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
       <button  id="btn_guardar_caja" type="submit" class="btn btn-default" title="Guardar" ><i class="fa fa-save"></i> Grabar Movimiento</button>
      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
  </form><!-- frm caja -->
</div><!-- /.modal -->
		
		
            
<script type="text/javascript">
$(document).ready(function() {
	
	$("#btn_agregar_comision").click(function(){
	    $("#div_comision").modal('show');
	    
	});
	$("#btn_agregar_caja").click(function(){
	    $("#div_agregarcaja").modal('show');
	});


	
 <?php if ($pedEdit['id'] == -1){
/****************************************************************************/	  
 	?>
		//pedido nuevo
		$('#div_cliente').show();
		$('#div_clientexiste').hide();
		//Ultima actualizacion
		$('#bx_infooter').hide();
		//Id pedido
		$('#lbl_id_pedido').hide();
		$('#bx_detalle').hide();
		$('#bx_agregardetalle').hide();
		$('#bx_seguimiento').hide();
		$('#bx_caja').hide();
		
  <?php 
  }else{
/****************************************************************************/	  	
 ?>
	  	$('#lbl_id_pedido').text(<?php echo $pedEdit['id']?>);
		$('#lbl_Nombcliente').text('<?php echo $pedEdit['cli_id']."-".$pedEdit['cli_nom'];  ?>');
		$('#fecha_ingreso').val('<?php echo $pedEdit['est_fec_ing']; ?>');
	   	<?php if ($pedEdit['ConFactura']==1){ ?>
	  		$('#chk_iva').prop('checked', true);
	   	<?php } //else confactura ?>

	   	<?php if ($pedEdit['comision']==1){ ?>
  		$('#chk_comision').prop('checked', true);
   		<?php } ?>
	   	

	  	//Show hide zone 
		$('#div_cliente').hide();
		$('#div_clientexiste').show();
		$('#bx_infooter').show();
		//Muestro el label del numero de pedido
		
		$('#lbl_id_pedido').show();
		$('#bx_detalle').show();
		$('#bx_agregardetalle').show();
		$('#bx_seguimiento').show();

		$('#bx_caja').show();
		
		buscaLineaDetalle ();
		buscaComisiones();
	  	
<?php } 
/****************************************************************************/
?>
		
	//inicio-----------------------------------------------------------------

	//Foprmateop de divisas para inputs
	$('#txt_costoventa').priceFormat({
	    prefix: '$ ',
	    centsSeparator: ',',
	    thousandsSeparator: '.',
	    centsLimit: 0
	});
	$('#txt_precioventa').priceFormat({
	    prefix: '$ ',
	    centsSeparator: ',',
	    thousandsSeparator: '.',
	    centsLimit: 0
	});

	$('#txt_monto').priceFormat({
	    prefix: '$ ',
	    centsSeparator: ',',
	    thousandsSeparator: '.',
	    centsLimit: 0
	});
	//Calendario fecha
	$("#fecha_ingreso").daterangepicker({
		format: 'YYYY-MM-DD',	
		singleDatePicker: true,
	});	
	// Control estado
	//$("#sl_estado").select2();
	

    function serverContaCall()
    {
        var idpedido = <?php echo $pedEdit['id'];?> ;
    	jQuery.ajax({
			method: "POST",
				url: "<?php echo base_url(); ?>Pedido/Conta",
				dataType: 'json',
				data: {idpedido},
				success: function(res){serverContaBack(res);}
		}); //jqueryajax				
    } 

    function serverContaBack(res)
    {
        if(res[0]!=null)
        {
    	$('#lbl_subtotal').text(PriceFormatter(res[0].Subtotal));
    	$('#lbl_iva').text(PriceFormatter(res[0].iva));
    	$('#lbl_totalapagar').text(PriceFormatter(res[0].totalAPagar));
    	$('#lbl_totalabonocliente').text(PriceFormatter(res[0].PagadoCliente));
    	$('#lbl_totalsaldocliente').text(PriceFormatter(res[0].SaldoCliente));


    	$('#lbl_totalCosto').text(PriceFormatter(res[0].CostoTotal));
    	
    	$('#lbl_totalganancia').text(PriceFormatter(res[0].Ganancia100));
    	//$('#lbl_totalRendido').text(PriceFormatter(res[0].AbonadoFabrica));
    	//$('#lbl_saldoArendir').text(PriceFormatter(res[0].SaldoFabrica));



    	//$('#recibidoVendedor1').text(PriceFormatter(res[0].recibidoVendedor1));
    	//$('#gananciaVendedor1').text(PriceFormatter(res[0].gananciaVendedor1));
    	//$('#SaldoVendedor1').text(PriceFormatter(res[0].SaldoVendedor1));
		//$('#recibidoVendedor2').text(PriceFormatter(res[0].recibidoVendedor2));
		//$('#gananciaVendedor2').text(PriceFormatter(res[0].gananciaVendedor2));
		//$('#SaldoVendedor2').text(PriceFormatter(res[0].SaldoVendedor2));
        }
		//alert(eval(res[0].id_cabecera));
    }

	
   

	/*
		*Evento que controla la opcion de pedido con factura.
	*/
	$('#chk_iva').change(function () {
		
		var idpedido 	=   <?php echo $pedEdit['id'];?> //$("#numeroPedido").val();
		var chk_iva_val 	=  $("#chk_iva").is(':checked');
		
		jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Pedido/ActualizaCF",
						dataType: 'json',
						data: {idpedido,chk_iva_val},
						success: function(res){buscaLineaDetalle ();}
			}); //jqueryajax				
	 });
	/* 
		Control busqueda de producto
	*/ 
	$( "#cntrl_id_producto" ).change(function() {
		
		var idprod = $( "#cntrl_id_producto" ).val();
		
		jQuery.ajax({
					method: "GET",
						url: "<?php echo base_url(); ?>Productos/ObtieneProductoPorId/"+idprod,
						dataType: 'json',
						
						success: function(res) {
									
									$('#txt_precioventa').val(PriceFormatter(res[0].valor_venta));
									$('#txt_costoventa').val(PriceFormatter(res[0].costo));
									
									
									
							}
			}); //jqueryajax		  
	});
	// FIN inicio-----------------------------------------------------------------
	
	function eliminaComision(row)
	{
		var id = row['id'];
		jQuery.ajax({
			method: "POST",
				url: "<?php echo base_url(); ?>Cuenta/eliminaComision/",
				data:{id},
				dataType: 'json',
				success: function(res) {buscaComisiones ();buscaLineaDetalle();}
	}); //jqueryajax	
	}
	
	/*Funcion elimina linea de detalle de un pedido.*/
	function eliminaDetallePedido(row)
	{
		var id_detalle = row['id'];
		
		var cantidad = row['cantidad'];
		var desc_prod = row['desc_prod'];
		
		if(confirm('Â¿ Seguro desea eliminar la linea de detalle ' + cantidad +  ' de ' + desc_prod +'?' ))
		{
			jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Pedido/EliminaLineaDetalle/",
						data:{id_detalle},
						dataType: 'json',
						success: function(res) {buscaLineaDetalle ();}
			}); //jqueryajax		
		}
	}
	/*
		Crea columnas con el boton de eliminar
	*/
	function operateFormatter(value, row, index) {
        return [
           /*'<a class="like" href="javascript:void(0)" title="Like">',
            '<i class="glyphicon glyphicon-heart"></i>',
            '</a>  ',*/
            '<a class="remove" id="cl_remove" href="javascript:void(0)" title="Remove">',
            '<i class="glyphicon glyphicon-remove"></i>',
            '</a>'
        ].join('');
    }


	function buscaComisiones(){
		window.eventosTablaComision = {
		        'click .remove': function (e, value, row, index) {
						eliminaComision(row);
		        }	
				};
		
		 $("#div_comision").modal('hide');
		 var idpedido 	=  <?php echo $pedEdit['id'];?> //$("#numeroPedido").val();
	   	  $('#table_comision').bootstrapTable('destroy').bootstrapTable
	   	  ({
				    url: '<?php echo base_url(); ?>Cuenta/MuestraComision/'+idpedido,
				    method:"GET",
					dataType: 'json',
					columns:[
								{field: 'id',title: 'id.', visible:'false'},
								{field: 'nom_cta',title: 'Cuenta.'}, 
								{field: 'porcentaje',title: 'Porcentaje',align: 'right'},
								{field: 'operate',title: 'AcciÃ³n',align: 'center',events: eventosTablaComision,formatter:operateFormatter}
					]
	        });

	}
 
	/*
	* ACtualiza desde la BD los detalles del pedido, ontiene el pedido desde el hidden #numeroPedido
	*/

	

	

	
	function buscaLineaDetalle ()
	{
		
		$("#div_agregarcaja").modal('hide');
		
		window.eventosTablaDetalle = {
		        'click .remove': function (e, value, row, index) {
						eliminaDetallePedido(row);
		        }	
				};
	   /*window.eventosTablaCaja = {
	    'click .remove': function (e, value, row, index) {
		        eliminaMovCaja(row);
        }
		};*/
	  var idpedido 	=  <?php echo $pedEdit['id'];?> //$("#numeroPedido").val();
   	  $('#tabla_detalle').bootstrapTable('destroy').bootstrapTable
   	  ({
			    url: '<?php echo base_url(); ?>Pedido/ajax_getLinesPedido/' + idpedido,
			    onLoadSuccess: function (res) {serverContaCall();},
			    data:{idpedido:idpedido},
				method: "GET",
				columns:[
							{field: 'id',title: 'ID'},
							{field: 'cantidad',title: 'Qty'},
							{field: 'nom_prod',title: 'Desc.'}, 
							{field: 'venta_un',title: 'Venta',align: 'right',formatter: PriceFormatter},
							{field: 'costo_un',title: 'Costo',align: 'right',formatter: PriceFormatter},
							{field: 'det_venta',title: 'Total Venta',align: 'right',formatter: PriceFormatter},
							{field: 'det_costo',title: 'Total Costo',align: 'right',formatter: PriceFormatter},
							{field: 'det_ganancia',title: 'Ganancia',align: 'right',formatter: PriceFormatter},
							{field: 'operate',title: 'AcciÃ³n',align: 'center',events: eventosTablaDetalle,formatter:operateFormatter}
                    
							
				]
        });
		
	
   	  $('#tb_resumen_cta').bootstrapTable('destroy').bootstrapTable
 	  ({
			    url: '<?php echo base_url(); ?>Cuenta/ResumenCuentaPedido/' + idpedido,
				onLoadSuccess: function (res) {serverContaCall();},
			    data:{idpedido:idpedido},
				method: "GET",
				columns:[
							{field: 'nombre_cta',title: 'Cta.'},
							{field: 'debe',title: 'Debe',formatter: PriceFormatter},
							{field: 'haber',title: 'Haber',formatter: PriceFormatter},
							{field: 'saldo',title: 'Saldo',formatter: PriceFormatter}
				]
       });
   	
	}

	
	$("#frm_comision").validate({
		submitHandler: function(form){
			//TODO validacion antes de grabar
			
			var porcentaje 	=  $("#txt_porcentaje").val();
			var cta = $("#cntrl_id_cta_comision").val();
			
			//alert(cta_des);
			var idcabecera =   <?php echo $pedEdit['id'];?>//$("#numeroPedido").val();
			
			jQuery.ajax({
				method: "POST",
					url: "<?php echo base_url(); ?>Cuenta/insertaComision",
					dataType: 'json',
					data: {cta,porcentaje,idcabecera},
					success: function(res) {
								if (res)
								{
									alert("Comision Ingresado.");
								}else
								{
									alert("ERROR al insertar Comision");
								}
								buscaComisiones();
								buscaLineaDetalle();
						}
				}); //jqueryajax
			
			}//function				
	});//frm_comision	

	// formulario caja , movimieno
	$("#frm_caja").validate({
  				submitHandler: function(form){
				//TODO validacion antes de grabar
				
				var txt_monto 	=  $("#txt_monto").unmask();
				var cta = $("#cntrl_id_cta").val();
				var cta_des = $("#cntrl_id_cta_destino").val();
				var glosa = $("#txt_glosa").val();
				//alert(cta_des);
				if (cta_des == null)
					cta_des = -1;
				var idcabecera =   <?php echo $pedEdit['id'];?>//$("#numeroPedido").val();
				if (txt_monto!="")
				{
				jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Cuenta/insertaTransaccion",
						dataType: 'json',
						data: {txt_monto,cta,cta_des,idcabecera,glosa},
						success: function(res) {
									if (res)
									{
										alert("Monto Ingresado.");
									}else
									{
										alert("ERROR al insertar Monto");
									}
									buscaLineaDetalle ();
							}
					}); //jqueryajax
  				}
				}				
	});	
	
	//formulario seguimiento, comentarios
	$("#frm_shout").validate({
  				submitHandler: function(form){
				//TODO validacion antes de grabar
				event.preventDefault();
				var idpedido 	=  <?php echo $pedEdit['id'];?>//$("#numeroPedido").val();
				var comm           =  $("#txt_comentario").val();
				var estado = $("#sl_estado").val();
				
				if (comm.length>0)
				{
				jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Comentario/grabaComentario",
						dataType: 'json',
						data: {idpedido,estado,comm},
						success: function(res) {
									if (res)
									{
										alert("Comentario "+res.id+" insertado correctamente.");
										window.location.href = "<?php echo base_url(); ?>Pedido/nuevoPedido/"+res.idpedido;
									}else
									{
										alert("ERROR al insertar Comentario");
									}
							}
					}); //jqueryajax
  				}
				}				
	});	
	
	//Submit formulario detalle		
	$("#frm_det_pedido").validate({
  				submitHandler: function(form){
				//TODO validacion antes de grabar
				event.preventDefault();
				// Linea detalle
				var cantidad    =  $("#txt_cantidad").val();
				var costoventa  =  $("#txt_costoventa").unmask();
				var precioventa =  $("#txt_precioventa").unmask();
				var idproducto   =  $("#cntrl_id_producto").val();
				var idpedido 	=  <?php echo $pedEdit['id'];?>//$("#numeroPedido").val();
				
				jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Pedido/grabaDetalle",
						dataType: 'json',
						data: {cantidad,idproducto,costoventa,precioventa,idpedido},
						success: function(res) {
									if (res)
									{
										//Detalle grabado, se agregò una nueva linea al pedido
										 $("#txt_cantidad").val('');
										 $("#txt_costoventa").val('');
										 $("#txt_precioventa").val('');
										 $("#cntrl_id_producto").val('');
										
									}else
									{
										alert("ERROR al actualizar los detalles del pedido");
									}
									buscaLineaDetalle();
							}
					}); //jqueryajax
  				}	
	});

	//Submit formulario cabecera
	$("#frm_pedido").validate({
  				submitHandler: function(form){
				//TODO validacion antes de grabar
				event.preventDefault();
				var idpedido 	=  <?php echo $pedEdit['id'];?>//$("#numeroPedido").val();
				var idcliente;
				if ($("#cntrl_id_cliente").val()!= null)
				{
					idcliente =  $("#cntrl_id_cliente").val();
				}else
				{
					idcliente = <?php 
						if($pedEdit['cli_id']=="")
							echo "-1";
						else
							echo $pedEdit['cli_id']; 
					
					?>;
				}
				var fecha_ingreso  =  $("#fecha_ingreso").val();
				var comm           =  $("#txt_comments").val();
				var idestado       =  $("#sl_estado").val();

				
				//var comision 	   =  $("#chk_comision").is(':checked');
				
				jQuery.ajax({
					method: "POST",
						url: "<?php echo base_url(); ?>Pedido/grabaCabecera",
						dataType: 'json',
						data: {idpedido,idcliente,fecha_ingreso,comm,idestado,comm},
						success: function(res) {
									if (res)
									{
										alert("Pedido "+res.id+" actualizado correctamente.");
										window.location.href = "<?php echo base_url(); ?>Pedido/nuevoPedido/"+res.id;
									}else
									{
										alert("ERROR al actualizar cabecera pedido");
									}
							}
					}); //jqueryajax
  				}	
	});			

	//********** Control Cliente **************************************		
			var $select = $("#cntrl_id_cliente");
			$select.select2({
				ajax: {
				        url: "<?php echo base_url(); ?>Cliente/listadoClientes/",
				        dataType: 'json',
				        method:'get',
				        quietMillis: 250,
				        
				        processResults: function (data, page) {
				        	var res = [];

					    	for(var i = 0; i < data.length; i++){
					    	    res[i] = {id:data[i].id,text:data[i].nombre};
					    	}
					    	 return {results: res};

					         var more = (page * 30) < res.total_count; // whether or not there are more results available


					         // Here we should have the data object
					        	$option.text(data.text).val(data.id); // update the text that is displayed (and maybe even the value)
					        	$option.removeData(); // remove any caching data that might be associated
					        	$select.trigger('change'); // notify JavaScript components of possible changes
					 			
				            // notice we return the value of more so Select2 knows if more results can be loaded
				            return { results: res, more: more };
				        }
				    },
				    escapeMarkup: function (m) { return m; }, // we do not want to escape markup since we are displaying html in results
				    placeholder: "Seleccione un cliente"
			});

			//********** Control Producto **************************************			
			$("#cntrl_id_producto").select2({
				ajax: {
				        url: "<?php echo base_url(); ?>Productos/listadoControlProductos/",
				        dataType: 'json',
				        method:'get',
				        quietMillis: 250,
				        maximumSelectionSize: 0,
				        processResults: function (data, page) {
				        	var res = [];
					    	
					    	for(var i = 0; i < data.length; i++){
					    	    res[i] = {id:data[i].id,text:data[i].nombre};
					    	}
					    	 return {results: res};

					            var more = (page * 30) < res.total_count; // whether or not there are more results available
				 			
				            // notice we return the value of more so Select2 knows if more results can be loaded
				            return { results: res, more: more };
				        }
				    },
				    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
				});

			//********** Control cta comisión **************************************			
			$("#cntrl_id_cta_comision").select2({
				ajax: {
				        url: "<?php echo base_url(); ?>Cuenta/listadoControlCuenta/",
				        dataType: 'json',
				        method:'get',
				        quietMillis: 250,
				        maximumSelectionSize: 0,
				        processResults: function (data, page) {
				        	var res = [];
					    	
					    	for(var i = 0; i < data.length; i++){
					    	    res[i] = {id:data[i].id,text:data[i].Nombre};
					    	}
					    	 return {results: res};

					            var more = (page * 30) < res.total_count; // whether or not there are more results available
				 			
				            // notice we return the value of more so Select2 knows if more results can be loaded
				            return { results: res, more: more };
				        }
				    },
				    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
				});

			
			//********** Control cta1 **************************************			
			$("#cntrl_id_cta").select2({
				ajax: {
				        url: "<?php echo base_url(); ?>Cuenta/listadoControlCuenta/",
				        dataType: 'json',
				        method:'get',
				        quietMillis: 250,
				        maximumSelectionSize: 0,
				        processResults: function (data, page) {
				        	var res = [];
					    	
					    	for(var i = 0; i < data.length; i++){
					    	    res[i] = {id:data[i].id,text:data[i].Nombre};
					    	}
					    	 return {results: res};

					            var more = (page * 30) < res.total_count; // whether or not there are more results available
				 			
				            // notice we return the value of more so Select2 knows if more results can be loaded
				            return { results: res, more: more };
				        }
				    },
				    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
				});	
			//********** Control cta2 **************************************			
			$("#cntrl_id_cta_destino").select2({
				ajax: {
				        url: "<?php echo base_url(); ?>Cuenta/listadoControlCuenta/",
				        dataType: 'json',
				        method:'get',
				        quietMillis: 250,
				        maximumSelectionSize: 0,
				        processResults: function (data, page) {
				        	var res = [];
					    	
					    	for(var i = 0; i < data.length; i++){
					    	    res[i] = {id:data[i].id,text:data[i].Nombre};
					    	}
					    	 return {results: res};

					            var more = (page * 30) < res.total_count; // whether or not there are more results available
				 			
				            // notice we return the value of more so Select2 knows if more results can be loaded
				            return { results: res, more: more };
				        }
				    },
				    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
				});


			$('#btnback').click(function () {
				window.history.back();
			});
				
}); //Function ready
</script>
 
