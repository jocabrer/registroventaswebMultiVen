
<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Reporte extends CI_Controller {

	
	public function index()
	{
	    $dataContent['titleHeader']        = "Sistema de reportes LYM";
	    $dataContent['descHeader']   	   = "Hojas de trabajo, analisis de ventas, Sistema lym.";
	    
	    
	    //Autenticación
	    if (!$this->ion_auth->logged_in())
	    {
	        redirect('auth/login');
	        
	    }else
	    {
	        $this->load->template('v_blank', $dataContent);
	    }
	}
	
	public function hojas(){
	    
	    $dataContent['titleHeader']        = "Sistema de reportes LYM";
	    $dataContent['descHeader']   	   = "Hojas de trabajo, analisis de ventas, Sistema lym.";
	    
	    //indicadores contadores
	    $dataContent['ind_ingresado']=$this->M_estados->get_cantidadEstado(0);
	    $dataContent['ind_enfabricacion']=$this->M_estados->get_cantidadEstado(1);
	    $dataContent['ind_esperando']=$this->M_estados->get_cantidadEstado(2);
	    $dataContent['ind_listos']=$this->M_estados->get_cantidadEstado(3);
	    
	    
	    //Autenticación
	    if (!$this->ion_auth->logged_in()){
	        redirect('auth/login');        
	    }else  {
	        $this->load->template('v_hoja', $dataContent);
	    }
	}
	
	public function procesaHojaPedidos(){
	    
	    if (! $this->ion_auth->logged_in ()) {
	        redirect ( 'auth/login' );
	    }
	    $json = file_get_contents('php://input');
	    $obj = json_decode($json);
	    
	    //var_dump($obj);
	    
	    //exit(0);
	    if( (!Isset($obj->nrospedidos))||(!Isset($obj->nombrehoja)) || (!Isset($obj->tipohoja))|| (!Isset($obj->procesa)) )
	    {
	           return "";
	    }
	    else{
	        
	      //  var_dump($obj->nrospedidos);
 //	        exit(0);
	        if ($obj->nrospedidos=="") return "vacia";
	        
	    	        $idpedidos = $obj->nrospedidos;
	    	        $nombre_hoja = $obj->nombrehoja;
	    	        $tipo_hoja = $obj->tipohoja;
	    	        $procesa = $obj->procesa;
	    }
	    //echo $procesa;
	    //exit(0);

	    if($procesa==TRUE)
	       $this->calculaHoja($idpedidos,$nombre_hoja,$tipo_hoja);
	    

	    $data =  $this->M_pedido->get_hoja($nombre_hoja);
	    
	    $data2['rows'] = $data;
	    $data2['total'] = count($data);
	    
	    echo json_encode($data);
	    
	}
	
	function calculaHoja($idpedidos,$nombre_hoja,$tipo_hoja){
	    
	    $data = $this->M_pedido->get_ListadoPedidoFormatoHoja($idpedidos);
	    $this->M_pedido->limpia_hoja($nombre_hoja,$tipo_hoja);
	    $cab_ante = 0;
	    $cont = 0;
	    
	    foreach ($data as $pedido){
	        $cont++;
	        
	        $tipo = $tipo_hoja;
            $fechaingreso = $pedido['fechaingreso'];
            $nropedido = $pedido['pedido'];
            $cantidad = $pedido['cantidad'];
            $producto = $pedido['producto'];
            $costo_cu = $pedido['costo_cu'];
            $tot_costo = $pedido['tot_costo'];
            $pagado = $pedido['pagado'];
            $saldo = $pedido['saldo'];
            $iva = $pedido['iva'];
            
            if($cab_ante == $pedido['pedido']){
                $pagado = 0;
                $saldo = 0;
                $iva = 0;
            }
            $fecha_proceso  =new DateTime('America/Argentina/Mendoza');
	           
            $id_reg = $this->M_pedido->insert_entry_hoja($tipo,$fechaingreso,$nropedido,$cantidad,$producto,$costo_cu,$tot_costo,$pagado,$saldo,$iva,$fecha_proceso,$nombre_hoja,$cont);
            $cab_ante =  $pedido['pedido'];
	    }
	}
}
