<?php

class M_pedido extends CI_Model {

  	function __construct()
    {
        // Call the Model constructor
        parent::__construct();
		
    }
    
    /**
	
	/**
	 * Funcion que elimina un pedido de la base de datos
	 * @param int $id_pedido el pedido id a eliminar
	 * @return boolean true o false segun corresponda
	 */
	function eliminaPedido($id_pedido){
        
	    $this->db->trans_start();
	    $this->db->query("DELETE FROM hojas WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM cabecera_notas WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM comentarios WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM movimiento_cab WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM movimiento_cta WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM cambioestado WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM detalle WHERE id_cabecera = ".$id_pedido.";");
	    $this->db->query("DELETE FROM cabecera WHERE id = ".$id_pedido.";");
	    $this->db->trans_complete(); 
	    
	    if ($this->db->trans_status() === FALSE)
	    {
	       return false;
	    }else 
	        return true;
	        
	}
	/**
	 * Elimina línea de detalle de pedido
	 */
	function eliminaLineaDetallePedido($id)
	{
		return $this->db->simple_query("DELETE FROM  `detalle` WHERE `id` = ".$id);
	}
	/**
	 * Actualiza la propiedad ConFactura
	 * @param unknown $id_pedido cabecera a actualizar
	 * @param unknown $chkiva valor a actualizar
	 */
	function actualizaPedidoPropiedadFactura($id_pedido,$chkiva)
	{
		
		$this->db->simple_query("UPDATE `cabecera` SET `ConFactura` = ".(int)$chkiva." WHERE `id` = '".$id_pedido."'");
		
	}
    /**
     * Actualiza los datos de la cabecera de un pedido.
     * @param $id_cabecera
     * @param $id_estado
     * @param $fec_ing
     */
	function actualizaPedidosDatosCabecera($id_cabecera,$id_estado,$id_user,$fecha_mod)
	{
	    //extrañamente poniendo y d m funcion no asi y-m-d
	    //$fec_ing = date_format(DateTime::createFromFormat('Y-m-d', $fec_ing),'Y-m-d H:i:s');
	    if($id_estado!=-1)
		  $this->estadoActual   = $id_estado;
		//$this->fecha_ingreso  = $fec_ing;
		if($id_user<>-1){
		    $this->id_user = $id_user;
		}
		$this->fecha_mod = $fecha_mod->format('Y-m-d H:i:s');;
		$this->db->update('cabecera', $this, array('id' => $id_cabecera));
	}
	/**
	 * Inserta la cabacera de un nuevo pedido.
	 * @param unknown $id_cliente
	 * @param unknown $fecha
	 * @param unknown $id_user
	 * @param unknown $fecha_mod
	 * @return unknown
	 */
	function insertaPedidoCabecera($id_cliente,$fecha,$id_user,$fecha_mod)
    {
        $fecha = date_format(DateTime::createFromFormat('Y-m-d H:i:s', $fecha),'Y-m-d H:i:s');

        $this->id_cliente    = $id_cliente;
        $this->fecha_ingreso  = $fecha ;
        $this->conFactura = 0;
        $this->id_user = $id_user;
        $this->fecha_mod = $fecha_mod->format('Y-m-d H:i:s');
        
        $this->db->insert('cabecera', $this);
        $insert_id = $this->db->insert_id();
        
        return  $insert_id;
    }
    /**
     * Inserta una nueva linea de detalle para el pedido
     * @param int $idpedido
     * @param int $cant
     * @param int $idprod
     * @param double $cos
     * @param double $pri
     * @return Id insertado
     */
 	function insertaPedidoLineaDetalle($idpedido,$cant,$idprod,$cos,$pri)
    {
    	unset( $this->id_cliente);
    	unset($this->estadoActual);
    	
        $this->cantidad    = $cant;
        $this->id_cabecera = $idpedido;
        $this->valor_cli   = $pri;
        $this->costo 	   = $cos;
		$this->id_producto = $idprod;
        $this->db->insert('detalle', $this);
        $insert_id = $this->db->insert_id();
        
        return  $insert_id;
    }
    /**
     * Inserta una nota al pedido
     * @param int $id_pedido
     * @param varchar $nota
     * @param date $fecha_ing
     * @param int $userid
     */
    function insertaPedidoNota($id_pedido,$nota,$fecha_ing,$userid){
        
        $existeNOta = $this->db->where('id_cabecera',$id_pedido)->from('cabecera_notas')->count_all_results();
        
        $this->id_cabecera = $id_pedido;
        $this->id_user   = $userid;
        $this->nota 	   = $nota;
        $this->fecha_mod = $fecha_ing;
        
        if ($existeNOta==0)
        {
            $this->db->insert('cabecera_notas', $this);
        }else{
            $this->db->update('cabecera_notas', $this, array('id_cabecera' => $id_pedido));
        }
        
        
    }
    
    
    
	/**
	 * Obtiene un registro de cabecera para el id 
	 * @param int $idcabecera 
	 */
    function obtenerPedido($idcabecera)
	{
		$this->db->where('id',$idcabecera);
		$query = $this->db->get('v_cabecera');
		return $query->result_array();
	}
	/**
	 * Obtiene las líneas de detalle tabla:detalle  de cada pedido tabla:cabecera
	 * @param int $id_cabecera
	 * @return Detalles del pedido
	 */
	function obtenerPedidoDetalle($id_cabecera)
	{
	    $this->db->where('id_cabecera',$id_cabecera);
	    $query = $this->db->get('v_totaldetallepedido');
	    return $query->result();
	}
	/**
	 * Obtiene un listado de pedido en formato de reporte tipo hojas de trabajo.
	 * @param varchar $idpedidos
	 * @return Array de pedidos.
	 */
	function ObtenerPedidosFormatoListaHja($idpedidos)
	{
	    /* $query = "SELECT
	    
	    lp.`est_fec_ing` AS fechaingreso,
	    dp.id_cabecera AS pedido,
	    dp.`cantidad` AS cantidad,
	    dp.nom_prod AS producto,
	    dp.`costo_un` costo_cu,
	    dp.`det_costo` AS tot_costo,
	    dh.haber AS pagado,
	    lp.`SaldoFabrica` AS saldo,
	    lp.`iva`
	    FROM `v_totaldetallepedido` dp
	    INNER JOIN `v_listadopedidoextendido` lp ON dp.`id_cabecera` = lp.`numeroPedido`
	    LEFT JOIN v_cuentasdebehaber dh ON dp.id_cabecera = dh.id_cabecera  AND dh.id_cuenta = 2
	    WHERE dp.id_cabecera  IN (".$idpedidos.");";
	    
	    return  $this->db->query($query)->result_array();*/
	    //echo $this->db->last_query();
	    //exit(0);
	    $this->db->from('v_reportehoja');
	    $this->db->where_in('pedido', $idpedidos);
	    $this->db->order_by("pedido", "asc");
	    
	    return $this->db->get()->result_array();
	    
	    
	    
	    
	}
	/***
	 * Listado de pedido en base a criterios
	 */
	function ObtenerPedidosListado($criterio,$limit,$estados,$ordenarpor,$orden,$slcomision,$cliente)
	{
	    $data = $this->db->select('*')->from('v_listadopedidoextendido');
	    $data = $this->db->where_in(' estado_sec', $estados);
	    
	    if($cliente!="todos")
	        $data = $this->db->where(' cli_id', $cliente);
	        
	        if($slcomision <> -1){
	            $data = $this->db->where(' comision', $slcomision);
	        }
	        if($criterio!=""){
	            
	            $data = $this->db->group_start();
	            $data = $this->db->or_where(' numeroPedido =', $criterio);
	            $data = $this->db->or_like(' cli_nom', $criterio);
	            $data = $this->db->or_where(' cli_nom =', $criterio);
	            $data = $this->db->group_end();
	        }
	        $data = $this->db->limit($limit);
	        $data = $this->db->order_by($ordenarpor, $orden);
	        return $this->db->get()->result_array();
	        
	        //echo $this->db->last_query();
	        //exit(0);
	        
	}
	/**
	 * Obtiene los indicadores de un pedido
	 * @param int $idpedido
	 * @return Indicadores
	 */
	function obtenerPedidoIndicadores($idpedido)
	{
	    $query = $this->db->query("SELECT
                                        ind.*,
                                        IFNULL(dh.haber,0) AS PagadoCliente,
                                        (IFNULL(dh.debe,0)-IFNULL(dh.haber,0)) SaldoCliente
                                    FROM
                                        v_indicador_lite ind
                                        LEFT JOIN v_cuentasdebehaber dh  ON ind.id_cabecera = dh.id_cabecera AND dh.tipo = 0
                                    WHERE ind.id_cabecera 	= " . $idpedido);
	    
	    return $query->result();
	}
	/**
	 * Obtiene los datos de seguimiento de la vista v_seguimiento
	 * @param unknown $idcabecera
	 * @param unknown $idcliente
	 * @return unknown
	 */
	function obtenerPedidoSeguimiento($idcabecera, $idcliente){
	    
	    //v_seguimiento
	    $this->db->where('pedido',$idcabecera);
	    $this->db->where('id_cliente',$idcliente);
	    
	    $query = $this->db->get('v_seguimiento');
	    
	    return $query->result_array();
	}
	/*function get_Hoja($hoja)
	{
	    $query = $this->db->where('nombre_hoja',$hoja);
	    $query =$this->db->order_by('orden', 'asc');
	    $query =$this->db->get('hoja');
	    return $query->result_array();
	}
	
	function get_Hojas()
	{
	    $query =$this->db->order_by('orden', 'asc');
	    $query =$this->db->get('hoja');
	    return $query->result_array();
	}*/
	
	function existePedidoCliente($idcabecera,$idcliente){
	    
	    $this->db->where('id', $idcabecera);
	    $this->db->where('id_cliente', $idcliente);
	    $this->db->from('cabecera');
	    $cant =  $this->db->count_all_results();
	    if ($cant>0)
	        return true;
	        else
	            return false;
	}
	function existePedido($idcabecera)
	{
		$this->db->where('id', $idcabecera);
		$this->db->from('cabecera');
		$cant =  $this->db->count_all_results();
		if ($cant>0)
			return true;
		else 
			return false;
	}
	
	
	
	

}

?>