<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Cliente extends CI_Controller {

	
	public function index()
	{
		redirect('Cliente/listado');
	}
	/*
	| -------------------------------------------------------------------
	|  Listado de clientes 
	| -------------------------------------------------------------------
	| Módulo que muestra los ultimos 10 clientes activos (pedido NO cerrado) 
	|
	*/	
	public function listado()
	{
		$dataContent['titleHeader']        = $this->lang->line('titleHeader'); 
		$dataContent['descHeader']   	   = $this->lang->line('descHeader'); 
		$dataContent['titulocliente']      = $this->lang->line('titulocliente'); 
		
		//Autenticación 
		if (!$this->ion_auth->logged_in())
		{
			redirect('auth/login');
		
		}else
		{
			$this->load->template('v_cliente_listado', $dataContent);
		}
	}
	/*
	*  El agregar cliente despliega el formulario para ser rellenado
	*
	*/
	public function edicion($idClie = -1)
	{
		if (! $this->ion_auth->logged_in ()) {
			redirect ( 'auth/login' );
		} else {
				
			$dataContent['titleHeader']        = $this->lang->line('NuevoCliente'); 
			$dataContent['descHeader']   	   = $this->lang->line('NuevoCliente2'); 
			$dataContent['tituloFormcliente']  = $this->lang->line('tituloFormcliente'); 
				
			//INicialización control estado
			//$dataContent ['vEstados'] =  $this->M_estados->get_Estados();
				
			$idclie = $this->input->post('idcliente');
			$nombre = $this->input->post('txt_nombre');
			
			
			
			
			
			
			if ($idClie <> -1)
			{
				//Tenemos un id cliente pero igual se valida que exista.
				$cliEdit = $this->M_cliente->GetCliente($idClie);
				
				if (count($cliEdit)==0)
					redirect('Cliente/edicion');
				
					
					//var_dump($cliEdit[0]['observaciones']);
					$cliEdit[0]['observaciones']= json_decode($cliEdit[0]['observaciones']);// $cliEdit[0]['observaciones']; //json_decode($cliEdit[0]['observaciones']);
					
					//var_dump($cliEdit[0]);
					
				//Editar
				$dataContent['descHeader']   =  "Editar Cliente id ";
				//Existe, lo asigno
				$dataContent['cliEdit'] = $cliEdit[0];
			}else{
			    
			    //Nuevo obj cliente
			    $dataContent['cliEdit'] = array (
			        'id' =>-1,
			        'nombre' => '',
			        'nombre2' => '',
			        'correo1' => '',
			        'correo2' => '',
			        'fono1' => '',
			        'fono2' => '',
			        'fono1' => '',
			        'giro' => '',
			        'rut' => '',
			        'domicilio' => '',
			        'comuna' => '',
			        'observaciones' => ''
			    );
			}
			
			$this->load->template ( 'v_cliente', $dataContent );
		}
	}
	/**
	 * Ajax : Para el control de Seleccionar cliente del pedido.
	 *
	 *
	 * Devuelve y filtra el listado de clientes
	 */
	public function listadoClientes() {
		// Seguridad
		if (! $this->ion_auth->logged_in ()) {
			redirect ( 'auth/login' );
		}
		// Fin Seguridad
	
		// Rescato variable POST que me manda el control select2 para filtrar los resultados
		$criterio = $this->input->get ( 'q', TRUE );
		;
		If ($criterio == "")
		$criterio = ""; // Criterio para despistar
	
		// Obtengo los clientes según criterio
		$data = $this->M_cliente->getAllControl( $criterio );
		// Transformo los nombres para evitar problemas entre JSON y los tildes y otros caracteres
		//foreach ( $data as $key => $value ) {
		//	$data [$key] ['nombre'] = utf8_encode ( $value ['nombre'] );
		//}
		echo json_encode ( $data );
	}
	public function salir()
	{
		$this->ion_auth->logout();		
		redirect('auth/login');
	}
	
	
	/**
	 * Graba un nuevo cliente 
	 */
	public function grabaCliente()
	{
	    // Seguridad
	    if (! $this->ion_auth->logged_in ()) {
	        redirect ( 'auth/login' );
	    }
	    
	    
	    $user = $this->ion_auth->user()->row();
	    $userid = $user->id;
	    
	    
	    
		$idclie = $this->input->post('idcliente');
		$nombre = ucwords (strtolower($this->input->post('txt_nombre')));
		$correo = strtolower($this->input->post('txt_correo'));
		$nombr2 = ucwords (strtolower($this->input->post('txt_nombre2')));
		$corre2 = strtolower($this->input->post('txt_correo2'));
		$fono1  = $this->input->post('txt_fono1');
		$fono2  = $this->input->post('txt_fono2');
		$rut    = $this->input->post('txt_rut');
		$giro   = $this->input->post('txt_giro');
		$direc  = $this->input->post('txt_domicilio');
		$comuna = $this->input->post('txt_comuna');
		$obs    = $this->input->post('txt_observaciones');
		
		
		if (!$this->existe($idclie)){
		    $idclie = $this->M_cliente->insert_entry($nombre,$correo,$nombr2,$corre2,$fono1,$fono2,$rut,$giro,$direc,$comuna,$obs,$userid,new DateTime('America/Argentina/Mendoza'));
		}else{
		    $this->M_cliente->update_entry($idclie,$nombre,$correo,$nombr2,$corre2,$fono1,$fono2,$rut,$giro,$direc,$comuna,$obs,$userid,new DateTime('America/Argentina/Mendoza'));
		}
		
		$arr = array ('id' => $idclie);
		echo json_encode ( $arr );
	}
	/*
	 * Indica si existe o no un cliente.
	 */
	public function existe($idcliente) {
		if ($idcliente == -1 || $idcliente == null)
			return false;
			// echo "id ".$idpedido;
	
			$cliente_encontrado = $this->M_cliente->getCliente($idcliente);
	
			if (count($cliente_encontrado) == 0)
				return false;
				else
				return true;
	}
	
	
	/**
	 * Busca cliente para no grabar uno ya existente
	 * @param unknown $criterio
	 */
	/*public function buscaCliente($criterio){
	    
	    if (! $this->ion_auth->logged_in ()) {
	        redirect ( 'auth/login' );
	    }
	    $data = $this->M_cliente->getClientes($criterio,$limit,$ordenarpor,$orden);
	}*/
	/*
	 * Funcion que llamael control de usuario select
	 */
	public function ajax_getClientes()
	{
		if (! $this->ion_auth->logged_in ()) {
			redirect ( 'auth/login' );
		}
		$json = file_get_contents('php://input');
		$obj = json_decode($json);
		
		//var_dump($obj);
		//exit(0);
		
		isset ($obj->search)?$criterio = $obj->search:$criterio =  "" ;
		isset ($obj->limit)?$limit = $obj->limit:$limit = "10000" ;
		isset ($obj->sort)?$ordenarpor =  $obj->sort:$ordenarpor =  "id" ;
		isset ($obj->order)?$orden =  $obj->order:$orden =  "desc" ;
		$data = $this->M_cliente->getClientes($criterio,$limit,$ordenarpor,$orden);
		$data2 ['rows'] = $data;
		echo json_encode($data2);
	}
}
