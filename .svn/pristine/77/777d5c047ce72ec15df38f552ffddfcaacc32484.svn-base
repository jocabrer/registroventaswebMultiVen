ALTER VIEW v_indicadorespedido AS 

SELECT 
	tot_det.`id_cabecera`
	
	,SUM(tot_det.`venta_tot`) Subtotal
	,SUM(
		CASE cab.ConFactura 	
		WHEN 1 THEN tot_det.`venta_tot`*0.19
		ELSE 0
		END
	) iva
	,SUM(tot_det.`venta_tot`+(
		CASE cab.ConFactura 	
		WHEN 1 THEN tot_det.`venta_tot`*0.19
		ELSE 0
		END
	)) totalAPagar
	,SUM(cta_tipo0.`saldo`) PagadoCLiente 
	,SUM(tot_det.`venta_tot`+(CASE cab.ConFactura WHEN 1 THEN tot_det.`venta_tot`*0.19 ELSE 0 END)-cta_tipo0.`saldo`) SaldoCLiente 
	
	,SUM(tot_det.`costo_tot`) CostoTotal
	,SUM(IFNULL(cta_tipo2.`saldo`,0)) AbonadoFabrica 
	,SUM((tot_det.`costo_tot`-IFNULL(cta_tipo2.`saldo`,0))
	+/* El iva se paga a la fabrica */
	CASE cab.ConFactura 	
		WHEN 1 THEN tot_det.`venta_tot`*0.19
		ELSE 0
		END
	) SaldoFabrica 
	
	,SUM(tot_det.ganancia_tot) Ganancia100
	
	,SUM(`cta_tipo1_1`.`saldo`) recibidoVendedor1
	,SUM(
	     CASE cab.`comision` 
		WHEN 0 THEN tot_det.`ganancia_tot`
		ELSE tot_det.`ganancia2_tot`
	     END
	) gananciaVendedor1
	,SUM(
	     (CASE cab.`comision` 
		WHEN 0 THEN tot_det.`ganancia_tot`
		ELSE tot_det.`ganancia2_tot`
	     END)-`cta_tipo1_1`.`saldo`
	) SaldoVendedor1 /*recibidoVendedor1-gananciaVendedor1*/
	
	,SUM(IFNULL(`cta_tipo1_2`.`saldo`,0)) recibidoVendedor2
	,SUM(
	     CASE cab.`comision` 
		WHEN 1 THEN tot_det.`ganancia2_tot`
		ELSE 0
	     END
	) gananciaVendedor2
	,SUM(
	     (CASE cab.`comision` 
		WHEN 1 THEN tot_det.`ganancia2_tot`
		ELSE 0
	     END)-IFNULL(`cta_tipo1_2`.`saldo`,0)
	) SaldoVendedor2 /*recibidoVendedor1-gananciaVendedor1*/
FROM	
        `v_cabecera` cab 
	INNER JOIN `v_totaldetallepedido1linea` tot_det ON cab.`id` = `tot_det`.`id_cabecera`
	LEFT JOIN v_saldoscuentapedido cta_tipo0 ON tot_det.`id_cabecera` = cta_tipo0.`id_cabecera` AND cta_tipo0.`tipo_cta` = 0
	LEFT JOIN v_saldoscuentapedido cta_tipo2 ON tot_det.`id_cabecera` = cta_tipo2.`id_cabecera` AND cta_tipo2.`tipo_cta` = 2
	LEFT JOIN v_saldoscuentapedido cta_tipo1_1 ON tot_det.`id_cabecera` = cta_tipo1_1.`id_cabecera` AND cta_tipo1_1.`tipo_cta` = 1 AND  `cta_tipo1_1`.`Entidad` = 'VEN1'
	LEFT JOIN v_saldoscuentapedido cta_tipo1_2 ON tot_det.`id_cabecera` = cta_tipo1_2.`id_cabecera` AND cta_tipo1_2.`tipo_cta` = 1 AND  `cta_tipo1_2`.`Entidad` = 'VEN2'
	
GROUP BY 
	tot_det.`id_cabecera`
	
	
	